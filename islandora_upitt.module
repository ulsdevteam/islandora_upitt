<?php
/**
        * @file
        * Adds custom template selection to Pitt's Islandora instance.
        */

/**
        * Implement hook_help().
        * $ret_val is assigned the return value.
        */
function islandora_upitt_help($path, $arg) {
        switch ($path) {
                case 'admin/help#islandora_upitt': {
                        $ret_val = '<h3>' . t('About') . '</h3>';
                        $ret_val .= '<p>' . t('The islandora_upitt module allows the user to apply a particular template file for use with a particular object type, e.g. an image, book, or newspaper. This way, the proper view will load by default.') . '</p>';
                        return $ret_val;
                        break;
                }
        }
}

function islandora_upitt_menu() {
  $items['admin/islandora/tools/islandora_upitt/settings'] = array(
    'title' => 'Islandora Pitt',
    'description' => 'Settings for various options within the University of Pittsburgh system and workflow.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_upitt_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );
  $items['islandora/object/%islandora_object/viewer'] = array(
    'title' => 'View Object',
    'page callback' => 'islandora_view_object',
    'page arguments' => array(2),
    'type' => MENU_CALLBACK,
    'weight' => -1,
    'access callback' => 'islandora_upitt_viewer_aaccess_callback',
    'access arguments' => array(ISLANDORA_VIEW_OBJECTS, 2),
  );
  if (variable_get('islandora_upitt_show_sitejump') == 1) {
    $items['islandora/object/%islandora_object/sitejump'] = array(
      'title' => variable_get('islandora_upitt_sitejump_tab_text', 'Site Jump'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('islandora_upitt_sitejump', 2),
      'type' => MENU_LOCAL_TASK,
      'access arguments' => array('administer site configuration'),
    );
  }

  return $items;
}
function islandora_upitt_viewer_aaccess_callback($permission, $islandora_object) {
  /*
  drupal_static_reset('islandora_get_tuque_connection');
  $connection = islandora_get_tuque_connection();
  $page = $connection->repository->getObject('pitt:collection.137');
  $page->relationships->add('info:fedora/fedora-system:def/relations-external#', 'isMemberOfCollection', 'pitt:root');
  */


  if(islandora_object_access_callback($permission, $islandora_object) && in_array('islandora:collectionCModel', $islandora_object->models) == FALSE) {
    return TRUE;
  }
  else {
    return FALSE;
  }
}

function islandora_upitt_menu_alter(&$items) {
  $items['islandora/object/%islandora_object']['page callback'] = 'islanora_upitt_view';
  $items['islandora/object/%islandora_object/view']['page callback'] = 'islanora_upitt_view';
  $items['islandora/object/%islandora_object/view']['title'] = 'Metadata';
}

function islanora_upitt_view($islandora_object) {
  if (in_array('islandora:collectionCModel', $islandora_object->models) === FALSE) {
    return theme('islandora_upitt_view', array('islandora_object' => $islandora_object));
  }
  else {
    return islandora_view_object($islandora_object);
  }
}

function islandora_upitt_theme() {
  return array(
    'islandora_upitt_view' => array(
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora-upitt-view',
      'variables' => array(
        'islandora_object' => NULL,
      ),
    ),
  );
}

/**
 * This hook allows modules to register XSLT self-transformations.
 *
 * @return array
 *   An associative array mapping a shortened name to the full path of the
 *   transformation.
 */
function islandora_upitt_xml_form_builder_get_self_transforms() {
  return array(
    'pitt_cleanup_mods.xslt' => str_replace(DRUPAL_ROOT.'/', '', dirname(__FILE__).'/transforms/pitt_cleanup_mods.xsl'),
  );
}

function islandora_upitt_sitejump() {
  if (variable_get('islandora_upitt_show_sitejump') == 1) {
    $path = str_replace(":", "%3A", current_path());
    drupal_goto(variable_get('islandora_upitt_sitejump_domain', 'gamera.library.pitt.edu') . $path);
  }
}


